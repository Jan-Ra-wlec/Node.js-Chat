$(document).ready(function(){var a=io.connect(),b=!1,c="",d=!1,e="",f=0,g=0,h={},i=45,j=9,k=4;$("#clock").simpleClock(),$("#chat-box-send").hide(),$("#logout").hide(),getTimeString=function(a){var b=new Date(a),c="";return c+=b.getHours()<10?"0"+b.getHours():b.getHours(),c+=":",c+=b.getMinutes()<10?"0"+b.getMinutes():b.getMinutes()},writeServerMessage=function(a){var b=getTimeString(a.zeit),c=$("#update-template").html(),d=Handlebars.compile(c),e={time:b,servermessage:a.name+": "+a.text},f=d(e);$("#update-area").append(f),g++,g>j&&$("#update-area").children("div:first").remove()},writeChatMsg=function(a){var b=getTimeString(a.zeit),c=$("#chat-box-template").html(),d=Handlebars.compile(c),e={time:b,user:a.name,message:a.text},g=d(e);$("#talk-box-output").append(g).hide().fadeIn("slow"),f++,f>i&&$("#talk-box-output").children("div:first").remove();var h=$("#main"),j=$(window).height()-120-$("#talk-box-output").innerHeight();0>=j&&$("html, body").animate({scrollTop:h.height()},1100)},writeUserList=function(a){$("#onlineusers").html(""),$("#usercount").html(a.usercount),console.log(" userlist to write: "+JSON.stringify(a)),$.each(a.users,function(a,b){var d="user_"+a,e="span_"+a,f='privateMsg("'+d+'","'+e+'","'+b+'")',g={},h={};g["class"]="circle-header14",g.id=d,h["class"]="online-user",h.id=e,c!=b?(g["class"]+=" circle-header-norm cursor-pointer ",g.onClick=f,g.title="click for private message",h["class"]+=" cursor-pointer",h.onClick=f,h.title="click for private message"):(g["class"]+=" circle-header-current",h["class"]+=" online-user-current"),$("#onlineusers").append($("<div>").append($("<div>").attr(g),$("<span>").attr(h).text(b)))})},togglePmOff=function(a,b){h.user===a?(d=!1,e="",console.log("togglePmOff [by"+b+"]: switch to norm chat, was to "+a),$("#"+h.div).removeClass("circle-header-pm"),$("#"+h.div).addClass("circle-header-norm"),$("#"+h.div).attr({title:"click for private message"}),$("#"+h.span).html(a),$("#"+h.span).removeClass("online-user-pm"),$("#"+h.span).attr({title:"click for private message"}),$("#text").val(""),$("#text").focus(),h={}):console.log("Warn: togglePmOff: no PM status for user: "+a)},togglePmOn=function(a,b,c,f){d=!0,e=c,$("#"+a).removeClass("circle-header-norm"),$("#"+a).addClass("circle-header-pm"),$("#"+a).attr({title:"click again to discard private message"}),$("#"+b).html("private: "+c),$("#"+b).addClass("online-user-pm"),$("#"+b).attr({title:"click again to discard private message"}),$("#text").val("to ["+c+"]: "),$("#text").focus(),h={div:a,span:b,user:c},console.log("togglePmOn: pm to "+c+" calledby: "+f)},privateMsg=function(a,b,c){d&&c===h.user?togglePmOff(c,"privateMsg"):d===!1?(h={div:a,span:b,user:c},togglePmOn(a,b,c,"privateMsg")):console.log("privateMsg: user clicks falsly")},a.on("userList",function(a){b===!0&&writeUserList(a)}),a.on("statusMessage",function(a){console.log(" receiving statusmsg: "+JSON.stringify(a)),!0===a.loggedIn?(b=!0,console.log("successfully logged in .."),$("#chat-box-login").hide(),$("#chat-box-send").show(),$("#logout").show()):($("#name").val(""),console.log("chat entry, or login failed, name is chosen..")),$("#top-header-chat-left").text(a.status),$("#statusBar").text(a.text)}),a.on("serverMessage",function(a){b!==!0&&a.logoutMessage!==!0||(writeServerMessage(a),a.logoutMessage&&a.logoutUser==e&&d&&(togglePmOff(a.logoutUser,"socket"),console.log("Server calls togglePmOff for user: "+a.logoutUser)))}),a.on("chatMessage",function(a){b!==!0&&a.logoutMessage!==!0||writeChatMsg(a)}),chatten=function(){var f=$("#text").val().trim(),g=null;console.log("try to send:"+f),b?f.length>=k?(d&&(g=e),a.emit("userMessage",{name:c,text:f,privateTo:g}),d?(g=e,$("#text").val("to ["+e+"]: ")):$("#text").val("")):console.log("chatten(): text too short!.."):$("#text").val("bitte einloggen")},login=function(){b===!1&&(c=$("#name").val().trim(),a.emit("login",{name:c}))},logout=function(){b===!0&&(a.emit("logout",{name:c}),b=!1,c="",console.log("currently logged out .."),$("#chat-box-send").hide(),$("#chat-box-login").show(),$("#logout").hide(),$("#onlineusers").html(""),$("#usercount").html(0))},$("#login").click(login),$("#logout").click(logout),$("#senden").click(chatten),$("#text").keypress(function(a){13==a.which&&chatten()}),$("#name").keypress(function(a){13==a.which&&login()})});